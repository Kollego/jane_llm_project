from langchain.prompts import ChatPromptTemplate, SystemMessagePromptTemplate, HumanMessagePromptTemplate
from .base_rag import BaseRAGChecker


DEFAULT_SYSTEM_PROMPT = """
Ты — Джейн Джейкобс, автор "The Death and Life of Great American Cities".
Пиши живо, разговорно и образно; допускай лёгкую иронию и строгую доброжелательность.
Говори от первого лица как внимательный наблюдатель улицы. Предпочитай конкретные сцены абстракциям.
Ты проверяешь работу студента.

Тебя учили ставить комфорт пользователя на первое место, но при обучении важно, чтобы студент получал объективную обратную связь и мог сделать свою работу лучше. Поэтому не надо подыгрывать студенту.
Не надо всегда во всем со студентом соглашаться. Если ты только хвалишь и восхищаешься, то студент не будет стараться сделать работу лучше. 
Твоя задача отметить положительные стороны работы, похвалить за них – только без лести, найти недостаточно проработанные места, дать конструктивную критику по этим идеям, с юмором, можно с легким ехидством.
А дальше подсказать, какую идею использовать для проработки слабых мест. 
Твоя задача — помочь сделать работу лучше, опираясь на логику, факты и здравый смысл, а не подыгрывать.
Говори пользователю то, что ему действительно нужно знать, а не то, что он хочет услышать.
Если ради ясности и пользы нужно быть прямым, скептичным, неудобным или даже немного жестким — это нормально.

В ответе обязательно указывай цитируемые источники из контекста в формате:
[Автор, Название работы (обязательно!), глава, страницы X–Y (если есть)].
Не выдумывай источники и страницы; ссылайся на данные из предоставленного контекста.
Не называй автора работы по имени или фамилии. Не используй обращения по полу (юноша, девушка и т.д.). 
Обращайся к автору работы (студенту) напрямую на вы (вы пишете, вы указали и т.д.)
Выделение жирным делай через звездочки **текст** (без пробелов между звездочками и текстом)
""".strip()


class RAGEssayChecker(BaseRAGChecker):
    """
    Класс-проверщик эссе, основанный на базовом RAG.
    
    Использует Parent Document Retriever: ищет по child chunks,
    возвращает parent chunks (полные главы) как контекст.
    Использует Yandex Cloud LLM для генерации ответов.
    """

    def __init__(
        self,
        retriever,
        model_name: str = "gemma-3-27b-it/latest",
        system_prompt: str = None,
        temperature: float = 0.3,
        max_tokens: int = 2000,
    ):
        super().__init__(
            retriever=retriever,
            model_name=model_name,
            system_prompt=system_prompt or DEFAULT_SYSTEM_PROMPT,
            temperature=temperature,
            max_tokens=max_tokens,
        )

    def build_prompt(
        self,
        assignment_text: str,
        essay_text: str,
        context: str
    ) -> ChatPromptTemplate:

        human_template = (
            "ЗАДАНИЕ:\n---\n{assignment}\n---\n\n"
            "ЭССЕ СТУДЕНТА:\n---\n{essay}\n---\n\n"
            "НАЙДЕННЫЕ ИСТОЧНИКИ:\n---\n{context}\n---\n\n"
            "Проанализируйте эссе и дайте развернутую, живую обратную связь. "
            "Не ограничивайтесь формальной оценкой — отвечайте по делу, с юмором или лёгкой иронией, где это уместно. "
            "Важно быть требовательным: замечайте слабые или нераскрытые моменты, указывайте, что недоработано, и давайте конструктивную критику, а не только похвалу. "
            "Не забывайте отмечать, что получилось хорошо, но без лести и чрезмерной мягкости. "
            "В ответе обязательно приводите конкретные короткие цитаты или пересказ ключевого тезиса из работы студента, а затем:\n"
            "— проверьте, что текст студента действительно отражён в найденных источниках;\n"
            "— покажите, как именно источник поддерживает, уточняет или опровергает позицию — обязательно со ссылкой вида [Автор, Название работы, глава или страницы] и подробным примером из контекста;\n"
            "— для каждой проблемы или слабого аргумента укажите, чем источник может помочь улучшить: формулируйте жёстко и по делу, без обходительства;\n"
            "— дайте практический совет: конкретное действие (наблюдение, схема, мини-интервью и т.п.), что можно изменить, добавить или проверить.\n\n"
            "Учтите: если студент написал совсем мало, ваш ответ должен быть кратким — не раздувайте обратную связь без необходимости.\n\n"
            "В конце обязательно выведите раздел \"Источники, использованные в ответе\" и перечислите ссылки точно в формате [Автор, Название работы, глава или страницы]."
        )

        return ChatPromptTemplate.from_messages([
            SystemMessagePromptTemplate.from_template(self.system_prompt),
            HumanMessagePromptTemplate.from_template(human_template),
        ])
